# Starship Installation and Configuration Script for Windows PowerShell
# Run this script with: powershell -ExecutionPolicy Bypass -File install.ps1

Write-Host "ðŸš€ Starting Starship installation for Windows..." -ForegroundColor Green
Write-Host ""

# Step 1: Install Starship via winget
Write-Host "Step 1: Installing Starship..." -ForegroundColor Cyan
Write-Host "Running: winget install --id Starship.Starship" -ForegroundColor Gray

try {
    winget install --id Starship.Starship --source winget --accept-source-agreements --accept-package-agreements
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "âœ“ Starship installed successfully" -ForegroundColor Green
    } else {
        Write-Host "âš  Installation completed with warnings (this is usually OK)" -ForegroundColor Yellow
    }
    
    # Refresh PATH to make starship available
    $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
    Start-Sleep -Seconds 2
    
} catch {
    Write-Host "âš  Error during installation: $_" -ForegroundColor Yellow
    Write-Host "Continuing with configuration..." -ForegroundColor Yellow
}

Write-Host ""

# Step 2: Install Anonymice Nerd Font
Write-Host "Step 2: Installing Anonymice Nerd Font..." -ForegroundColor Cyan

$fontUrl = "https://github.com/ChristianLempa/dotfiles/raw/main/Windows/Rainmeter/Skins/xcad/%40Resources/Fonts/Anonymice%20Nerd%20Font%20Complete.ttf"
$fontPath = "$env:TEMP\Anonymice_Nerd_Font_Complete.ttf"
$fontsFolder = (New-Object -ComObject Shell.Application).Namespace(0x14)

try {
    Write-Host "Downloading Anonymice Nerd Font..." -ForegroundColor Gray
    Invoke-WebRequest -Uri $fontUrl -OutFile $fontPath -UseBasicParsing
    
    if (Test-Path $fontPath) {
        Write-Host "Installing font..." -ForegroundColor Gray
        $fontsFolder.CopyHere($fontPath, 0x10)
        Write-Host "âœ“ Anonymice Nerd Font installed successfully" -ForegroundColor Green
        
        # Clean up
        Remove-Item $fontPath -Force -ErrorAction SilentlyContinue
    }
} catch {
    Write-Host "âš  Could not auto-install font. Please download manually from:" -ForegroundColor Yellow
    Write-Host "  $fontUrl" -ForegroundColor Gray
}

Write-Host ""

# Step 3: Create config directory and file
Write-Host "Step 3: Creating config directory and file..." -ForegroundColor Cyan
Write-Host "Running: mkdir -p ~/.config && touch ~/.config/starship.toml" -ForegroundColor Gray

$configDir = "$env:USERPROFILE\.config"
$starshipConfig = "$configDir\starship.toml"

# Create directory if it doesn't exist
if (-not (Test-Path $configDir)) {
    New-Item -ItemType Directory -Path $configDir -Force | Out-Null
    Write-Host "âœ“ Created directory: $configDir" -ForegroundColor Green
} else {
    Write-Host "âœ“ Directory already exists: $configDir" -ForegroundColor Green
}

# Backup existing config if it exists
if (Test-Path $starshipConfig) {
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    $backupPath = "$starshipConfig.backup_$timestamp"
    Copy-Item $starshipConfig $backupPath -Force
    Write-Host "âœ“ Backed up existing config to: $backupPath" -ForegroundColor Yellow
}

Write-Host ""

# Step 4: Add custom config to starship.toml
Write-Host "Step 4: Adding custom config to ~/.config/starship.toml..." -ForegroundColor Cyan

$starshipConfigContent = @'
# ~/.config/starship.toml

# Inserts a blank line between shell prompts
add_newline = true

format = """\
[â•­â•´](238)$env_var\
$all[â•°â”€](238)$character"""

[character]
success_symbol = "[](238)"
error_symbol = "[](238)"

[directory]
truncation_length = 3
truncation_symbol = "â€¦/"
home_symbol = " ~"
read_only_style = "197"
read_only = "  "
format = "at [$path]($style)[$read_only]($read_only_style) "

[git_branch]
symbol = " "
format = "on [$symbol$branch]($style) "
truncation_length = 4
truncation_symbol = "â€¦/"
style = "bold green"

[git_status]
format = '[\($all_status$ahead_behind\)]($style) '
style = "bold green"
conflicted = "ðŸ³"
up_to_date = " "
untracked = " "
ahead = "â‡¡${count}"
diverged = "â‡•â‡¡${ahead_count}â‡£${behind_count}"
behind = "â‡£${count}"
stashed = " "
modified = " "
staged = '[++\($count\)](green)'
renamed = "è¥ "
deleted = " "


[terraform]
format = "via [ terraform $version]($style) å£Ÿ [$workspace]($style) "

[vagrant]
format = "via [ vagrant $version]($style) "

[docker_context]
format = "via [ $context](bold blue) "

[helm]
format = "via [ $version](bold purple) "

[python]
symbol = " "
python_binary = "python3"

[nodejs]
format = "via [ $version](bold green) "

[ruby]
format = "via [ $version]($style) "

[kubernetes]
format = 'on [ $context\($namespace\)](bold purple) '
disabled = false
[kubernetes.context_aliases]
"clcreative-k8s-staging" = "cl-k8s-staging"
"clcreative-k8s-production" = "cl-k8s-prod"


[env_var.STARSHIP_DISTRO]
format = '[$env_value](bold white) '
variable = "STARSHIP_DISTRO"
disabled = false
'@

Set-Content -Path $starshipConfig -Value $starshipConfigContent -Encoding UTF8
Write-Host "âœ“ Custom config written to: $starshipConfig" -ForegroundColor Green

Write-Host ""

# Step 5: Configure PowerShell profile
Write-Host "Step 5: Configuring PowerShell to initialize starship..." -ForegroundColor Cyan
Write-Host "Adding to: `$PROFILE" -ForegroundColor Gray

$profilePath = $PROFILE.CurrentUserAllHosts
$profileDir = Split-Path -Parent $profilePath

# Create profile directory if it doesn't exist
if (-not (Test-Path $profileDir)) {
    New-Item -ItemType Directory -Path $profileDir -Force | Out-Null
    Write-Host "âœ“ Created profile directory" -ForegroundColor Green
}

# Backup existing profile
if (Test-Path $profilePath) {
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    $backupPath = "$profilePath.backup_$timestamp"
    Copy-Item $profilePath $backupPath -Force
    Write-Host "âœ“ Backed up existing profile to: $backupPath" -ForegroundColor Yellow
}

# Check if Starship is already in profile
$profileContent = ""
if (Test-Path $profilePath) {
    $profileContent = Get-Content $profilePath -Raw
}

if ($profileContent -match "starship init") {
    Write-Host "âœ“ Starship already configured in profile (skipping)" -ForegroundColor Yellow
} else {
    # Add Starship initialization to profile
    $starshipInit = @'

# Kubectl aliases (optional - comment out if not needed)
function k { kubectl @args }
function h { helm @args }

function kn {
    param([string]$namespace)
    if ($namespace) {
        kubectl config set-context --current --namespace=$namespace
        Write-Host "âœ“ Namespace set to $namespace" -ForegroundColor Green
    } else {
        Write-Host "âœ— Error, please provide a valid Namespace" -ForegroundColor Red
    }
}

function knd {
    kubectl config set-context --current --namespace=default
    Write-Host "âœ“ Namespace set to Default" -ForegroundColor Green
}

function ku {
    kubectl config unset current-context
    Write-Host "âœ“ unset kubernetes current-context" -ForegroundColor Green
}

# Initialize Starship
Invoke-Expression (&starship init powershell)
'@

    Add-Content -Path $profilePath -Value $starshipInit -Encoding UTF8
    Write-Host "âœ“ Added 'Invoke-Expression (&starship init powershell)' to profile" -ForegroundColor Green
}

Write-Host ""
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "âœ… Installation Complete!" -ForegroundColor Green
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""
Write-Host "What was done:" -ForegroundColor Yellow
Write-Host "  âœ“ Installed Starship via winget" -ForegroundColor White
Write-Host "  âœ“ Downloaded and installed Anonymice Nerd Font" -ForegroundColor White
Write-Host "  âœ“ Created ~/.config/starship.toml with box-drawing prompt style" -ForegroundColor White
Write-Host "  âœ“ Added 'Invoke-Expression (&starship init powershell)' to `$PROFILE" -ForegroundColor White
Write-Host "  âœ“ Added kubectl helper functions (k, h, kn, knd, ku)" -ForegroundColor White
Write-Host ""
Write-Host "Next steps:" -ForegroundColor Yellow
Write-Host "  1. Close this PowerShell window" -ForegroundColor White
Write-Host "  2. Open Windows Terminal Settings (Ctrl + ,)" -ForegroundColor White
Write-Host "  3. Go to: Defaults > Appearance > Font face" -ForegroundColor White
Write-Host "  4. Select: 'Anonymice Nerd Font'" -ForegroundColor White
Write-Host "  5. Click Save and restart your terminal" -ForegroundColor White
Write-Host ""
Write-Host "Files created/modified:" -ForegroundColor Cyan
Write-Host "  â€¢ Config: $starshipConfig" -ForegroundColor White
Write-Host "  â€¢ Profile: $profilePath" -ForegroundColor White
Write-Host "  â€¢ Font: C:\Windows\Fonts\Anonymice Nerd Font Complete.ttf" -ForegroundColor White
Write-Host ""
Write-Host "Your prompt will show:" -ForegroundColor Gray
Write-Host "  â•­â•´ [distro] at [directory] on  [branch] (status)" -ForegroundColor Gray
Write-Host "  â•°â”€ " -ForegroundColor Gray
Write-Host ""
Write-Host "To customize your prompt further, edit: $starshipConfig" -ForegroundColor Gray
Write-Host ""
Write-Host "Press Enter to exit..." -ForegroundColor Gray
Read-Host