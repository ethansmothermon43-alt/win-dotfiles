#Requires -RunAsAdministrator

<#
.SYNOPSIS
    Windows Environment Setup Script
.DESCRIPTION
    Configures Windows with dark mode, custom wallpaper, taskbar settings, 
    color scheme, font, and installs essential programs.
.NOTES
    Run as Administrator
#>

# Configuration
$WallpaperUrl = "https://raw.githubusercontent.com/ChristianLempa/hackbox/main/src/assets/mr-robot-wallpaper.png"
$WallpaperPath = "$env:USERPROFILE\Pictures\Wallpapers\mr-robot-wallpaper.png"
$FontUrl = "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/AnonymousPro.zip"
$FontPath = "$env:TEMP\AnonymousPro.zip"

# Color scheme from xcad_tdl
$AccentColor = 0xFF2A3D68  # RGB: 40, 61, 104 (bluish from your scheme)

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Windows Environment Setup Script" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# Function to set registry value
function Set-RegistryValue {
    param(
        [string]$Path,
        [string]$Name,
        [object]$Value,
        [string]$Type = "DWord"
    )
    
    if (!(Test-Path $Path)) {
        New-Item -Path $Path -Force | Out-Null
    }
    Set-ItemProperty -Path $Path -Name $Name -Value $Value -Type $Type -Force
}

# 1. Enable Dark Mode
Write-Host "[1/8] Enabling Dark Mode..." -ForegroundColor Yellow
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "AppsUseLightTheme" -Value 0
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "SystemUsesLightTheme" -Value 0
Write-Host "✓ Dark mode enabled" -ForegroundColor Green

# 2. Download and Set Wallpaper
Write-Host "[2/8] Setting wallpaper..." -ForegroundColor Yellow
$WallpaperDir = Split-Path $WallpaperPath
if (!(Test-Path $WallpaperDir)) {
    New-Item -ItemType Directory -Path $WallpaperDir -Force | Out-Null
}

try {
    Invoke-WebRequest -Uri $WallpaperUrl -OutFile $WallpaperPath -UseBasicParsing
    
    # Set wallpaper using SystemParametersInfo
    Add-Type -TypeDefinition @"
using System;
using System.Runtime.InteropServices;
public class Wallpaper {
    [DllImport("user32.dll", CharSet=CharSet.Auto)]
    public static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
}
"@
    [Wallpaper]::SystemParametersInfo(0x0014, 0, $WallpaperPath, 0x0001 -bor 0x0002)
    
    Set-RegistryValue -Path "HKCU:\Control Panel\Desktop" -Name "Wallpaper" -Value $WallpaperPath -Type String
    Write-Host "✓ Wallpaper set successfully" -ForegroundColor Green
} catch {
    Write-Host "✗ Failed to set wallpaper: $_" -ForegroundColor Red
}

# 3. Configure Taskbar (Christian Lempa style)
Write-Host "[3/8] Configuring taskbar..." -ForegroundColor Yellow

# Taskbar on left (Windows 11) or small icons (Windows 10)
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "TaskbarAl" -Value 0  # Left align
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "TaskbarSi" -Value 0  # Small taskbar
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "TaskbarSmallIcons" -Value 1  # Small icons
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "ShowTaskViewButton" -Value 0  # Hide Task View
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "TaskbarDa" -Value 0  # Hide Widgets
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Search" -Name "SearchboxTaskbarMode" -Value 0  # Hide Search

Write-Host "✓ Taskbar configured" -ForegroundColor Green

# 4. Set Accent Color (xcad_tdl theme)
Write-Host "[4/8] Setting accent color..." -ForegroundColor Yellow
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\DWM" -Name "AccentColor" -Value $AccentColor
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\DWM" -Name "ColorizationColor" -Value $AccentColor
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\DWM" -Name "ColorizationAfterglow" -Value $AccentColor
Set-RegistryValue -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "ColorPrevalence" -Value 1
Write-Host "✓ Accent color set" -ForegroundColor Green

# 5. Install Anonymice Nerd Font
Write-Host "[5/8] Installing Anonymice Nerd Font..." -ForegroundColor Yellow
try {
    Invoke-WebRequest -Uri $FontUrl -OutFile $FontPath -UseBasicParsing
    Expand-Archive -Path $FontPath -DestinationPath "$env:TEMP\AnonymousPro" -Force
    
    $FontFiles = Get-ChildItem -Path "$env:TEMP\AnonymousPro" -Filter "*.ttf"
    $FontsFolder = (New-Object -ComObject Shell.Application).Namespace(0x14)
    
    foreach ($Font in $FontFiles) {
        if ($Font.Name -like "*Nerd*") {
            $FontsFolder.CopyHere($Font.FullName, 0x10)
        }
    }
    
    Remove-Item -Path $FontPath -Force
    Remove-Item -Path "$env:TEMP\AnonymousPro" -Recurse -Force
    Write-Host "✓ Font installed successfully" -ForegroundColor Green
} catch {
    Write-Host "✗ Failed to install font: $_" -ForegroundColor Red
}

# 6. Install Winget (if not present)
Write-Host "[6/8] Checking for Winget..." -ForegroundColor Yellow
if (!(Get-Command winget -ErrorAction SilentlyContinue)) {
    Write-Host "Installing Winget..." -ForegroundColor Yellow
    $ProgressPreference = 'SilentlyContinue'
    Invoke-WebRequest -Uri "https://aka.ms/getwinget" -OutFile "$env:TEMP\winget.msixbundle"
    Add-AppxPackage -Path "$env:TEMP\winget.msixbundle"
    $ProgressPreference = 'Continue'
}
Write-Host "✓ Winget ready" -ForegroundColor Green

# 7. Install Programs
Write-Host "[7/8] Installing programs..." -ForegroundColor Yellow

$Programs = @(
    "Google.Chrome",
    "AgileBits.1Password",
    "Microsoft.WindowsTerminal",
    "Microsoft.PowerShell",
    "Microsoft.VisualStudioCode",
    "Git.Git",
    "Docker.DockerDesktop",
    "Canonical.Ubuntu.2004",
    "Python.Python.3.12",
    "OpenJS.NodeJS",
    "Notepad++.Notepad++",
    "7zip.7zip",
    "VideoLAN.VLC"
)

foreach ($Program in $Programs) {
    Write-Host "  Installing $Program..." -ForegroundColor Cyan
    try {
        winget install --id $Program --source winget --silent --accept-package-agreements --accept-source-agreements
        Write-Host "  ✓ $Program installed" -ForegroundColor Green
    } catch {
        Write-Host "  ✗ Failed to install $Program" -ForegroundColor Red
    }
}

# 8. Configure Windows Terminal with your settings
Write-Host "[8/8] Configuring Windows Terminal..." -ForegroundColor Yellow
$TerminalSettingsPath = "$env:LOCALAPPDATA\Packages\Microsoft.WindowsTerminal_8wekyb3d8bbwe\LocalState\settings.json"

if (Test-Path $TerminalSettingsPath) {
    # Backup existing settings
    Copy-Item $TerminalSettingsPath "$TerminalSettingsPath.backup" -Force
    
    # Note: Your settings.json from the document would be applied here
    # For now, we'll just set the default profile and font
    try {
        $settings = Get-Content $TerminalSettingsPath | ConvertFrom-Json
        $settings.profiles.defaults.fontFace = "Anonymice Nerd Font"
        $settings.profiles.defaults.fontSize = 15
        $settings.profiles.defaults.colorScheme = "xcad_tdl"
        $settings | ConvertTo-Json -Depth 100 | Set-Content $TerminalSettingsPath
        Write-Host "✓ Windows Terminal configured" -ForegroundColor Green
    } catch {
        Write-Host "✗ Failed to configure Windows Terminal: $_" -ForegroundColor Red
    }
}

# Restart Explorer to apply changes
Write-Host ""
Write-Host "Restarting Explorer to apply changes..." -ForegroundColor Yellow
Stop-Process -Name explorer -Force
Start-Sleep -Seconds 2

Write-Host ""
Write-Host "========================================" -ForegroundColor Green
Write-Host "Setup Complete!" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Green
Write-Host ""
Write-Host "Next steps:" -ForegroundColor Cyan
Write-Host "1. Restart your computer for all changes to take effect"
Write-Host "2. Open Windows Terminal and verify settings"
Write-Host "3. Configure 1Password and sign in"
Write-Host "4. Set up WSL distributions if needed"
Write-Host ""
Write-Host "Press any key to exit..."
$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
